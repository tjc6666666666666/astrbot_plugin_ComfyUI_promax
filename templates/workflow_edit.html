{% extends "base.html" %}

{% block title %}编辑 {{ workflow.config.name }} - 工作流配置{% endblock %}

{% block page_title %}编辑 {{ workflow.config.name }}{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <button type="submit" form="workflowForm" class="btn btn-success">
            <i class="bi bi-check-circle"></i>
            保存
        </button>
        <a href="{{ url_for('workflow_detail', workflow_name=workflow.name) }}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i>
            取消
        </a>
    </div>
{% endblock %}

{% block content %}
<form id="workflowForm" method="post" action="{{ url_for('workflow_save', workflow_name=workflow.name) }}">
    <!-- 基本信息 -->
    <div class="config-section p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-info-circle text-primary"></i>
                基本信息
            </h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSection(this)" data-bs-toggle="tooltip" title="展开/折叠">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        
        <div class="section-content" style="display: none;">
            <div class="row mb-3">
            <label class="col-sm-2 col-form-label">工作流名称</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="name" 
                       value="{{ workflow.config.name }}" required>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">前缀</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="prefix" 
                       value="{{ workflow.config.prefix }}" required>
                <div class="form-text">用于调用此工作流的前缀，如: encrypt</div>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">描述</label>
            <div class="col-sm-10">
                <textarea class="form-control" name="description" rows="3">{{ workflow.config.description or '' }}</textarea>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">版本</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="version" 
                       value="{{ workflow.config.version }}">
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">作者</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="author" 
                       value="{{ workflow.config.author }}">
            </div>
        </div>
        </div>
    </div>

    <!-- Workflow JSON -->
    <div class="config-section p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-code-slash text-info"></i>
                Workflow JSON
            </h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSection(this)" data-bs-toggle="tooltip" title="展开/折叠">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        
        <div class="section-content" style="display: none;">
            <div class="mb-3">
            <label class="form-label">ComfyUI Workflow JSON</label>
            <textarea class="form-control json-editor" name="workflow" rows="15" id="workflowJson">{{ workflow.workflow_json_pretty|safe }}</textarea>
            <div class="form-text">
                这是 ComfyUI 的 workflow JSON 配置，可以从 ComfyUI 界面导出。
            </div>
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-outline-primary" onclick="parseWorkflowNodes()">
                <i class="bi bi-arrow-repeat"></i>
                解析节点
            </button>
            <div class="form-text">点击此按钮解析 JSON 中的所有节点，然后可以在下方选择节点</div>
        </div>
        </div>
    </div>

    <!-- 节点配置 -->
    <div class="config-section p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-diagram-2 text-success"></i>
                节点配置
            </h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSection(this)" data-bs-toggle="tooltip" title="展开/折叠">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        
        <div class="section-content" style="display: none;">
            <div class="row mb-3">
            <label class="col-sm-2 col-form-label">输入节点</label>
            <div class="col-sm-10">
                <div id="inputNodesList">
                    {% for node in workflow.config.input_nodes %}
                    <div class="input-group mb-2">
                        <select class="form-select node-selector" name="input_nodes" onchange="updateMappingPreview()">
                            <option value="">-- 选择节点 --</option>
                        </select>
                        <button type="button" class="btn btn-outline-danger" onclick="removeInputNode(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addInputNode()">
                    <i class="bi bi-plus"></i>
                    添加输入节点
                </button>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">输出节点</label>
            <div class="col-sm-10">
                <div id="outputNodesList">
                    {% for node in workflow.config.output_nodes %}
                    <div class="input-group mb-2">
                        <select class="form-select node-selector" name="output_nodes" onchange="updateMappingPreview()">
                            <option value="">-- 选择节点 --</option>
                        </select>
                        <button type="button" class="btn btn-outline-danger" onclick="removeOutputNode(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOutputNode()">
                    <i class="bi bi-plus"></i>
                    添加输出节点
                </button>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">可配置节点</label>
            <div class="col-sm-10">
                <div id="configurableNodesList">
                    {% for node in workflow.config.configurable_nodes %}
                    <div class="input-group mb-2">
                        <select class="form-select node-selector" name="configurable_nodes">
                            <option value="">-- 选择节点 --</option>
                        </select>
                        <button type="button" class="btn btn-outline-danger" onclick="removeConfigurableNode(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addConfigurableNode()">
                    <i class="bi bi-plus"></i>
                    添加可配置节点
                </button>
            </div>
        </div>
        </div>
    </div>

    <!-- 自动映射预览 -->
    <div class="config-section p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-arrow-left-right text-warning"></i>
                自动映射预览
            </h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSection(this)" data-bs-toggle="tooltip" title="展开/折叠">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        
        <div class="section-content" style="display: none;">
            <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>自动映射规则：</strong>输入节点将自动映射为输入参数，输出节点将自动映射为输出参数。无需手动配置。
        </div>
        
        <!-- 输入映射预览 -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="mb-3">
                    <i class="bi bi-box-arrow-in-right"></i>
                    输入映射预览
                </h6>
                <div id="inputMappingsPreview" class="border rounded p-3 bg-light">
                    <p class="text-muted">暂无输入节点</p>
                </div>
            </div>
        </div>
        
        <!-- 输出映射预览 -->
        <div class="row">
            <div class="col-12">
                <h6 class="mb-3">
                    <i class="bi bi-box-arrow-right"></i>
                    输出映射预览
                </h6>
                <div id="outputMappingsPreview" class="border rounded p-3 bg-light">
                    <p class="text-muted">暂无输出节点</p>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- 节点参数配置 -->
    <div class="config-section p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-gear-fill text-warning"></i>
                节点参数配置
            </h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSection(this)" data-bs-toggle="tooltip" title="展开/折叠">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        
        <div class="section-content" style="display: none;">
            <div id="nodeConfigsContainer">
            {% for node_id, node_config in workflow.config.node_configs.items() %}
            <div class="param-item mb-4" data-node-id="{{ node_id }}">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="bi bi-cpu"></i>
                        <span class="node-title" data-node-id="{{ node_id }}">节点 {{ node_id }}</span>
                    </h6>
                    <div>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleNodeConfig(this)" data-bs-toggle="tooltip" title="展开/折叠">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeNodeConfig(this)">
                            <i class="bi bi-trash"></i>
                            删除节点配置
                        </button>
                    </div>
                </div>
                
                <div class="param-content" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="param-params-container">
                                {% for param_name, param_config in node_config.items() %}
                                <div class="param-config-item mb-3 p-3 border rounded" data-param-name="{{ param_name }}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>{{ param_name }}</strong>
                                        <div>
                                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleParamConfig(this)" data-bs-toggle="tooltip" title="展开/折叠">
                                                <i class="bi bi-chevron-down"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeParamConfig(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="param-config-content" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">参数名</label>
                                                <input type="text" class="form-control" name="param_name" 
                                                       value="{{ param_name }}" readonly>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">类型</label>
                                                <select class="form-select" name="param_type">
                                                    <option value="text" {% if param_config.type == 'text' %}selected{% endif %}>文本</option>
                                                    <option value="number" {% if param_config.type == 'number' %}selected{% endif %}>数字</option>
                                                    <option value="select" {% if param_config.type == 'select' %}selected{% endif %}>选择</option>
                                                    <option value="boolean" {% if param_config.type == 'boolean' %}selected{% endif %}>布尔值</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label class="form-label">默认值</label>
                                                <!-- 默认值输入框，会根据类型动态变化 -->
                                                <div class="param-default-container">
                                                    <input type="text" class="form-control param-default-text" name="param_default" 
                                                           value="{{ param_config.default if param_config.type in ['text', 'select'] else param_config.default or '' }}"
                                                           {% if param_config.type not in ['text', 'select'] %}style="display:none;"{% endif %}>
                                                    <input type="number" class="form-control param-default-number" name="param_default" 
                                                           value="{{ param_config.default if param_config.type == 'number' else '' }}" 
                                                           {% if param_config.type != 'number' %}style="display:none;"{% endif %} step="any">
                                                    <div class="form-check form-switch param-default-boolean" 
                                                         {% if param_config.type != 'boolean' %}style="display:none;"{% endif %}>
                                                        <input class="form-check-input" type="checkbox" name="param_default" 
                                                               {% if param_config.default == true %}checked{% endif %} onchange="updateBooleanLabel(this)">
                                                        <label class="form-check-label boolean-label">{% if param_config.default == true %}True{% else %}False{% endif %}</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <div class="form-check mt-4">
                                                    <input class="form-check-input" type="checkbox" name="param_required" 
                                                           {% if param_config.required %}checked{% endif %}>
                                                    <label class="form-check-label">必需参数</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label class="form-label">描述</label>
                                            <textarea class="form-control" name="param_description" rows="2">{{ param_config.description or '' }}</textarea>
                                        </div>
                                        
                                        <!-- 数字类型的范围设置 -->
                                        <div class="param-number-options" {% if param_config.type != 'number' %}style="display:none;"{% endif %}>
                                            <div class="row">
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label">最小值</label>
                                                    <input type="number" class="form-control" name="param_min" 
                                                           value="{{ param_config.min or '' }}" step="any">
                                                </div>
                                                <div class="col-md-6 mb-2">
                                                    <label class="form-label">最大值</label>
                                                    <input type="number" class="form-control" name="param_max" 
                                                           value="{{ param_config.max or '' }}" step="any">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 选择类型的选项设置 -->
                                        <div class="param-select-options" {% if param_config.type != 'select' %}style="display:none;"{% endif %}>
                                            <div class="mb-2">
                                                <label class="form-label">选项 (用逗号分隔)</label>
                                                <input type="text" class="form-control" name="param_options" 
                                                       value="{{ param_config.options | join(',') if param_config.options else '' }}"
                                                       placeholder="选项1,选项2,选项3">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label mb-0">特殊功能</label>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSpecialFeatures(this)" data-bs-toggle="tooltip" title="展开/折叠">
                                                    <i class="bi bi-chevron-down"></i>
                                                </button>
                                            </div>
                                            <div class="special-features-content" style="display: none;">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="param_inject_models" 
                                                           {% if param_config.inject_models %}checked{% endif %}>
                                                    <label class="form-check-label">注入可用模型列表</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="param_inject_loras" 
                                                           {% if param_config.inject_loras %}checked{% endif %}>
                                                    <label class="form-check-label">注入可用LoRA列表</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="param_inject_samplers" 
                                                           {% if param_config.inject_samplers %}checked{% endif %}>
                                                    <label class="form-check-label">注入可用采样器列表</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="param_inject_schedulers" 
                                                           {% if param_config.inject_schedulers %}checked{% endif %}>
                                                    <label class="form-check-label">注入可用调度器列表</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label class="form-label">别名 (用逗号分隔)</label>
                                            <input type="text" class="form-control" name="param_aliases" 
                                                   value="{{ param_config.aliases | join(',') if param_config.aliases else '' }}">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addParamConfig(this)">
                                <i class="bi bi-plus"></i>
                                添加参数
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <button type="button" class="btn btn-outline-primary" onclick="addNodeConfig()">
            <i class="bi bi-plus"></i>
            添加节点配置
        </button>
        </div>
    </div>

    <!-- 配置文件预览 -->
    <div class="config-section p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-file-text text-danger"></i>
                完整配置文件预览 (config.json)
            </h5>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSection(this)" data-bs-toggle="tooltip" title="展开/折叠">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
        
        <div class="section-content" style="display: none;">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>注意：</strong>这是将要保存到 config.json 文件的完整配置内容。提交表单后，此配置将被写入工作流的配置文件中。
            </div>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label">当前配置预览</label>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateConfigPreview()">
                        <i class="bi bi-arrow-clockwise"></i>
                        刷新预览
                    </button>
                </div>
                <div class="border rounded bg-dark">
                    <pre><code id="configPreview" class="text-light language-json">{
  "name": "{{ workflow.config.name }}",
  "prefix": "{{ workflow.config.prefix }}",
  "description": "{{ workflow.config.description or '' }}",
  "version": "{{ workflow.config.version or '' }}",
  "author": "{{ workflow.config.author or '' }}",
  "input_nodes": {{ workflow.config.input_nodes|tojson|safe }},
  "output_nodes": {{ workflow.config.output_nodes|tojson|safe }},
  "configurable_nodes": {{ workflow.config.configurable_nodes|tojson|safe }},
  "input_mappings": {},
  "output_mappings": {},
  "node_configs": {{ workflow.config.node_configs|tojson|safe }}
}</code></pre>
                </div>
                <div class="form-text">
                    此预览会根据您在上方表单中的选择实时更新。最终的配置文件将包含所有节点参数配置。
                </div>
            </div>
        </div>
    </div>

    <!-- 隐藏字段 -->
    <input type="hidden" name="config" id="configInput">
    
    <!-- 用于传递数据的隐藏字段 -->
    <input type="hidden" id="savedInputNodes" value="{{ workflow.config.input_nodes|tojson|safe }}">
    <input type="hidden" id="savedOutputNodes" value="{{ workflow.config.output_nodes|tojson|safe }}">
    <input type="hidden" id="savedConfigurableNodes" value="{{ workflow.config.configurable_nodes|tojson|safe }}">
</form>
{% endblock %}

{% block styles %}
<style>
.param-config-item {
    transition: all 0.3s ease;
}

.param-config-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.param-content {
    border-left: 3px solid #007bff;
    padding-left: 15px;
    margin-left: 10px;
}

.param-config-content {
    border-left: 2px solid #28a745;
    padding-left: 10px;
    margin-left: 5px;
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 10px;
}

.special-features-content {
    border-left: 2px solid #6c757d;
    padding-left: 10px;
    margin-left: 5px;
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 10px;
}

.section-content {
    border-left: 3px solid #007bff;
    padding-left: 15px;
    margin-left: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 15px;
}

.bi-chevron-down, .bi-chevron-up {
    transition: transform 0.2s ease;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// 直接在JavaScript中定义保存的数据
const savedData = {
    inputNodes: {{ workflow.config.input_nodes|tojson|safe }},
    outputNodes: {{ workflow.config.output_nodes|tojson|safe }},
    configurableNodes: {{ workflow.config.configurable_nodes|tojson|safe }}
};
// 解析 Workflow JSON 中的节点
function parseWorkflowNodes() {
    const workflowJsonElement = document.getElementById('workflowJson');
    if (!workflowJsonElement) {
        console.error('workflowJson element not found');
        return;
    }
    const workflowJson = workflowJsonElement.value;
    if (!workflowJson.trim()) {
        console.log('Workflow JSON 为空，跳过解析');
        return;
    }
    
    try {
        console.log('开始解析 Workflow JSON...');
        const workflow = JSON.parse(workflowJson);
        const nodes = [];
        
        // 提取所有节点信息
        for (const [nodeId, nodeData] of Object.entries(workflow)) {
            const title = nodeData._meta?.title || nodeData.class_type || `节点 ${nodeId}`;
            nodes.push({
                id: nodeId,
                title: title,
                class_type: nodeData.class_type
            });
        }
        
        // 按节点ID排序
        nodes.sort((a, b) => parseInt(a.id) - parseInt(b.id));
        console.log('解析到', nodes.length, '个节点:', nodes.map(n => n.id));
        
        // 更新所有下拉选择框
        updateAllNodeSelectors(nodes);
        
        // 如果有已存在的节点选择，恢复它们的值
        restoreExistingNodeValues();
        
        // 更新节点标题显示
        updateNodeTitles();
        
        // 触发自定义事件，表示节点解析完成
        document.dispatchEvent(new CustomEvent('nodesParsed'));
        console.log('节点解析完成');
        
    } catch (error) {
        console.error('JSON 格式错误：', error.message);
        console.error('JSON 内容:', workflowJson.substring(0, 200));
    }
}

// 更新所有节点选择器
function updateAllNodeSelectors(nodes) {
    const selectors = document.querySelectorAll('.node-selector');
    selectors.forEach(selector => {
        // 保存当前选中的值
        const currentValue = selector.value;
        
        // 清空并重新填充选项
        selector.innerHTML = '<option value="">-- 选择节点 --</option>';
        
        nodes.forEach(node => {
            const option = document.createElement('option');
            option.value = node.id;
            option.textContent = `${node.id} - ${node.title}`;
            if (node.class_type) {
                option.textContent += ` (${node.class_type})`;
            }
            selector.appendChild(option);
        });
        
        // 恢复之前选中的值
        if (currentValue) {
            selector.value = currentValue;
        }
    });
}

// 恢复已存在的节点值
function restoreExistingNodeValues() {
    // 这个函数会在页面加载时调用，用于恢复已保存的节点值
    const savedValues = {};
    
    // 收集所有已保存的值
    document.querySelectorAll('.node-selector').forEach(selector => {
        if (selector.value) {
            const name = selector.getAttribute('name');
            if (!savedValues[name]) savedValues[name] = [];
            savedValues[name].push(selector.value);
        }
    });
}

// 专门用于恢复已保存节点值的函数
function restoreSavedNodeValues() {
    try {
        console.log('开始恢复已保存的节点值...');
        console.log('保存的数据:', savedData);
        
        // 设置输入节点的值
        if (savedData.inputNodes && savedData.inputNodes.length > 0) {
            const inputNodes = savedData.inputNodes;
            const inputSelectors = document.querySelectorAll('select[name="input_nodes"]');
            console.log('输入节点:', inputNodes, '选择框数量:', inputSelectors.length);
            inputNodes.forEach((nodeId, index) => {
                if (inputSelectors[index]) {
                    inputSelectors[index].value = nodeId;
                    console.log('设置输入节点', index, '值为:', nodeId);
                }
            });
        }
        
        // 设置输出节点的值
        if (savedData.outputNodes && savedData.outputNodes.length > 0) {
            const outputNodes = savedData.outputNodes;
            const outputSelectors = document.querySelectorAll('select[name="output_nodes"]');
            console.log('输出节点:', outputNodes, '选择框数量:', outputSelectors.length);
            outputNodes.forEach((nodeId, index) => {
                if (outputSelectors[index]) {
                    outputSelectors[index].value = nodeId;
                    console.log('设置输出节点', index, '值为:', nodeId);
                }
            });
        }
        
        // 设置可配置节点的值
        if (savedData.configurableNodes && savedData.configurableNodes.length > 0) {
            const configurableNodes = savedData.configurableNodes;
            console.log('可配置节点:', configurableNodes);
            
            let configurableSelectors = document.querySelectorAll('select[name="configurable_nodes"]');
            console.log('当前可配置节点选择框数量:', configurableSelectors.length);
            
            // 检查是否需要创建更多的选择框
            while (configurableSelectors.length < configurableNodes.length) {
                console.log('创建新的可配置节点选择框...');
                addConfigurableNode();
                configurableSelectors = document.querySelectorAll('select[name="configurable_nodes"]');
            }
            
            // 重新获取选择框（因为可能添加了新的）
            configurableSelectors = document.querySelectorAll('select[name="configurable_nodes"]');
            
            // 设置值
            configurableNodes.forEach((nodeId, index) => {
                if (configurableSelectors[index]) {
                    configurableSelectors[index].value = nodeId;
                    console.log('设置可配置节点', index, '值为:', nodeId, '成功:', configurableSelectors[index].value === nodeId);
                    
                    // 验证选项是否存在
                    const optionExists = Array.from(configurableSelectors[index].options).some(option => option.value === nodeId);
                    console.log('节点', nodeId, '的选项是否存在:', optionExists);
                } else {
                    console.log('没有找到选择框', index);
                }
            });
        }
        
        // 更新映射预览
        updateMappingPreview();
        console.log('节点值恢复完成');
    } catch (error) {
        console.error('恢复节点值时出错:', error);
    }
}

// 添加输入节点
function addInputNode() {
    const list = document.getElementById('inputNodesList');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <select class="form-select node-selector" name="input_nodes" onchange="updateMappingPreview()">
            <option value="">-- 选择节点 --</option>
        </select>
        <button type="button" class="btn btn-outline-danger" onclick="removeInputNode(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    list.appendChild(div);
    
    // 如果已经解析过节点，更新选择器
    const workflowJsonElement = document.getElementById('workflowJson');
    if (workflowJsonElement && workflowJsonElement.value.trim()) {
        parseWorkflowNodes();
    }
    
    // 更新映射预览
    updateMappingPreview();
}

function removeInputNode(button) {
    button.parentElement.remove();
    updateMappingPreview();
}

// 添加输出节点
function addOutputNode() {
    const list = document.getElementById('outputNodesList');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <select class="form-select node-selector" name="output_nodes" onchange="updateMappingPreview()">
            <option value="">-- 选择节点 --</option>
        </select>
        <button type="button" class="btn btn-outline-danger" onclick="removeOutputNode(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    list.appendChild(div);
    
    // 如果已经解析过节点，更新选择器
    const workflowJsonElement = document.getElementById('workflowJson');
    if (workflowJsonElement && workflowJsonElement.value.trim()) {
        parseWorkflowNodes();
    }
    
    // 更新映射预览
    updateMappingPreview();
}

function removeOutputNode(button) {
    button.parentElement.remove();
    updateMappingPreview();
}

// 添加可配置节点
function addConfigurableNode() {
    const list = document.getElementById('configurableNodesList');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <select class="form-select node-selector" name="configurable_nodes">
            <option value="">-- 选择节点 --</option>
        </select>
        <button type="button" class="btn btn-outline-danger" onclick="removeConfigurableNode(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    list.appendChild(div);
    
    // 如果已经解析过节点，更新选择器
    const workflowJsonElement = document.getElementById('workflowJson');
    if (workflowJsonElement && workflowJsonElement.value.trim()) {
        parseWorkflowNodes();
    }
    
    // 更新映射预览
    updateMappingPreview();
}

function removeConfigurableNode(button) {
    button.parentElement.remove();
}

// 更新映射预览
function updateMappingPreview() {
    // 更新输入映射预览
    const inputNodes = Array.from(document.querySelectorAll('select[name="input_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    const inputPreview = document.getElementById('inputMappingsPreview');
    if (inputPreview) {
        if (inputNodes.length > 0) {
            const inputMappings = {};
            inputNodes.forEach(nodeId => {
                inputMappings[nodeId] = {
                    parameter_name: "image",
                    type: "image",
                    description: "输入的原始图像"
                };
            });
            inputPreview.innerHTML = `<pre><code>${JSON.stringify(inputMappings, null, 2)}</code></pre>`;
        } else {
            inputPreview.innerHTML = '<p class="text-muted">暂无输入节点</p>';
        }
    }
    
    // 更新输出映射预览
    const outputNodes = Array.from(document.querySelectorAll('select[name="output_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    const outputPreview = document.getElementById('outputMappingsPreview');
    if (outputPreview) {
        if (outputNodes.length > 0) {
            const outputMappings = {};
            outputNodes.forEach(nodeId => {
                outputMappings[nodeId] = {
                    parameter_name: "images",
                    type: "image",
                    description: "处理后的图像"
                };
            });
            outputPreview.innerHTML = `<pre><code>${JSON.stringify(outputMappings, null, 2)}</code></pre>`;
        } else {
            outputPreview.innerHTML = '<p class="text-muted">暂无输出节点</p>';
        }
    }
    
    // 同时更新配置预览
    updateConfigPreview();
}

// 更新配置预览
function updateConfigPreview() {
    const nameInput = document.querySelector('input[name="name"]');
    const prefixInput = document.querySelector('input[name="prefix"]');
    const descriptionInput = document.querySelector('textarea[name="description"]');
    const versionInput = document.querySelector('input[name="version"]');
    const authorInput = document.querySelector('input[name="author"]');
    
    const config = {
        name: nameInput ? nameInput.value : '',
        prefix: prefixInput ? prefixInput.value : '',
        description: descriptionInput ? descriptionInput.value : '',
        version: versionInput ? versionInput.value : '',
        author: authorInput ? authorInput.value : '',
        input_nodes: Array.from(document.querySelectorAll('select[name="input_nodes"]')).map(select => select.value).filter(v => v),
        output_nodes: Array.from(document.querySelectorAll('select[name="output_nodes"]')).map(select => select.value).filter(v => v),
        configurable_nodes: Array.from(document.querySelectorAll('select[name="configurable_nodes"]')).map(select => select.value).filter(v => v),
        input_mappings: {},
        output_mappings: {},
        node_configs: {}
    };
    
    // 自动生成输入输出映射
    const inputNodes = Array.from(document.querySelectorAll('select[name="input_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    const outputNodes = Array.from(document.querySelectorAll('select[name="output_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    inputNodes.forEach(nodeId => {
        config.input_mappings[nodeId] = {
            parameter_name: "image",
            type: "image",
            description: "输入的原始图像"
        };
    });
    
    outputNodes.forEach(nodeId => {
        config.output_mappings[nodeId] = {
            parameter_name: "images",
            type: "image",
            description: "处理后的图像"
        };
    });
    
    // 构建节点配置
    document.querySelectorAll('.param-item[data-node-id]').forEach(nodeItem => {
        const nodeId = nodeItem.getAttribute('data-node-id');
        config.node_configs[nodeId] = {};
        
        nodeItem.querySelectorAll('.param-config-item').forEach(paramItem => {
            const paramName = paramItem.getAttribute('data-param-name');
            const paramTypeSelect = paramItem.querySelector('select[name="param_type"]');
            const paramType = paramTypeSelect ? paramTypeSelect.value : 'text';
            
            // 根据类型获取默认值
            let defaultValue = null;
            switch(paramType) {
                case 'boolean':
                    const checkbox = paramItem.querySelector('.param-default-boolean input[name="param_default"]');
                    defaultValue = checkbox ? checkbox.checked : false;
                    break;
                case 'number':
                    const numberInput = paramItem.querySelector('.param-default-number');
                    defaultValue = numberInput && numberInput.value ? parseFloat(numberInput.value) : null;
                    break;
                default:
                    const textInput = paramItem.querySelector('.param-default-text');
                    defaultValue = textInput ? textInput.value || null : null;
            }
            
            const descriptionTextarea = paramItem.querySelector('textarea[name="param_description"]');
            const requiredCheckbox = paramItem.querySelector('input[name="param_required"]');
            const minInput = paramItem.querySelector('input[name="param_min"]');
            const maxInput = paramItem.querySelector('input[name="param_max"]');
            
            const paramConfig = {
                type: paramType,
                default: defaultValue,
                description: descriptionTextarea ? descriptionTextarea.value || '' : '',
                required: requiredCheckbox ? requiredCheckbox.checked : false
            };
            
            const minVal = minInput ? minInput.value : '';
            const maxVal = maxInput ? maxInput.value : '';
            if (minVal) paramConfig.min = parseFloat(minVal);
            if (maxVal) paramConfig.max = parseFloat(maxVal);
            
            const optionsInput = paramItem.querySelector('input[name="param_options"]');
            const options = optionsInput ? optionsInput.value : '';
            if (options) paramConfig.options = options.split(',').map(o => o.trim());
            
            const aliasesInput = paramItem.querySelector('input[name="param_aliases"]');
            const aliases = aliasesInput ? aliasesInput.value : '';
            if (aliases) paramConfig.aliases = aliases.split(',').map(a => a.trim());
            
            // 处理特殊功能
            if (paramItem.querySelector('input[name="param_inject_models"]')?.checked) {
                paramConfig.inject_models = true;
            }
            if (paramItem.querySelector('input[name="param_inject_loras"]')?.checked) {
                paramConfig.inject_loras = true;
            }
            if (paramItem.querySelector('input[name="param_inject_samplers"]')?.checked) {
                paramConfig.inject_samplers = true;
            }
            if (paramItem.querySelector('input[name="param_inject_schedulers"]')?.checked) {
                paramConfig.inject_schedulers = true;
            }
            
            config.node_configs[nodeId][paramName] = paramConfig;
        });
    });
    
    // 更新预览显示
    const configPreview = document.getElementById('configPreview');
    if (configPreview) {
        configPreview.textContent = JSON.stringify(config, null, 2);
    }
}

// 折叠/展开节点配置
function toggleNodeConfig(button) {
    const paramItem = button.closest('.param-item');
    const content = paramItem.querySelector('.param-content');
    const icon = button.querySelector('i');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// 更新节点标题显示
function updateNodeTitles() {
    const workflowJsonElement = document.getElementById('workflowJson');
    if (!workflowJsonElement || !workflowJsonElement.value.trim()) return;
    const workflowJson = workflowJsonElement.value;
    
    try {
        const workflow = JSON.parse(workflowJson);
        const nodeTitles = document.querySelectorAll('.node-title');
        
        nodeTitles.forEach(titleElement => {
            const nodeId = titleElement.getAttribute('data-node-id');
            const nodeData = workflow[nodeId];
            
            if (nodeData) {
                const nodeTitle = nodeData._meta?.title || nodeData.class_type || `节点 ${nodeId}`;
                titleElement.textContent = `${nodeId} - ${nodeTitle}`;
            }
        });
    } catch (error) {
        console.error('更新节点标题时出错:', error);
    }
}

// 折叠/展开参数配置
function toggleParamConfig(button) {
    const paramItem = button.closest('.param-config-item');
    const content = paramItem.querySelector('.param-config-content');
    const icon = button.querySelector('i');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// 折叠/展开主要部分
function toggleSection(button) {
    const section = button.closest('.config-section');
    const content = section.querySelector('.section-content');
    const icon = button.querySelector('i');
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// 折叠/展开特殊功能
function toggleSpecialFeatures(button) {
    console.log('toggleSpecialFeatures 被调用');
    
    // 方法1: 通过父元素查找
    let content = null;
    let container = button.parentElement; // 获取直接父元素
    
    console.log('按钮的直接父元素:', container);
    
    // 从当前父元素开始向上查找 special-features-content
    while (container && !content) {
        content = container.querySelector('.special-features-content');
        console.log('在容器中查找 special-features-content:', content);
        if (!content) {
            container = container.parentElement;
            console.log('向上移动到父元素:', container);
        }
    }
    
    // 如果还是找不到，尝试从按钮的下一个兄弟元素开始
    if (!content) {
        console.log('尝试从按钮的父元素查找下一个兄弟元素');
        const buttonParent = button.parentElement;
        let nextElement = buttonParent.nextElementSibling;
        console.log('按钮父元素的下一个兄弟元素:', nextElement);
        
        while (nextElement && !content) {
            if (nextElement.classList.contains('special-features-content')) {
                content = nextElement;
                console.log('找到 special-features-content:', content);
            } else {
                content = nextElement.querySelector('.special-features-content');
                console.log('在兄弟元素中查找 special-features-content:', content);
            }
            if (!content) {
                nextElement = nextElement.nextElementSibling;
            }
        }
    }
    
    const icon = button.querySelector('i');
    console.log('找到的图标元素:', icon);
    
    if (!content) {
        console.error('无法找到 special-features-content 元素');
        // 输出完整的DOM结构用于调试
        console.log('按钮的完整父级结构:', button.parentElement.parentElement.parentElement);
        return;
    }
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
        console.log('展开特殊功能');
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
        console.log('收缩特殊功能');
    }
}

// 添加节点配置
function addNodeConfig() {
    // 获取所有已选择的可配置节点
    const configurableNodes = Array.from(document.querySelectorAll('select[name="configurable_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    // 获取已经配置了参数的节点
    const existingConfigNodes = Array.from(document.querySelectorAll('.param-item[data-node-id]'))
        .map(item => item.getAttribute('data-node-id'));
    
    // 过滤出还未配置参数的节点
    const availableNodes = configurableNodes.filter(nodeId => !existingConfigNodes.includes(nodeId));
    
    if (availableNodes.length === 0) {
        alert('没有可配置的节点，请先在上方选择可配置节点');
        return;
    }
    
    // 创建选择对话框
    let nodeOptions = availableNodes.map(nodeId => {
        const selectElement = Array.from(document.querySelectorAll('select[name="configurable_nodes"]'))
            .find(select => select.value === nodeId);
        const optionText = selectElement ? selectElement.options[selectElement.selectedIndex].text : nodeId;
        return `<option value="${nodeId}">${optionText}</option>`;
    }).join('');
    
    // 创建模态框选择节点
    const modalHtml = `
        <div class="modal fade" id="nodeSelectModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">选择要配置的节点</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <select class="form-select" id="nodeSelect">
                            ${nodeOptions}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="confirmAddNodeConfig()">确定</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的模态框
    const existingModal = document.getElementById('nodeSelectModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('nodeSelectModal'));
    modal.show();
}

// 确认添加节点配置
function confirmAddNodeConfig() {
    const select = document.getElementById('nodeSelect');
    const nodeId = select.value;
    
    if (!nodeId) {
        alert('请选择一个节点');
        return;
    }
    
    const container = document.getElementById('nodeConfigsContainer');
    const div = document.createElement('div');
    div.className = 'param-item mb-4';
    div.setAttribute('data-node-id', nodeId);
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">
                <i class="bi bi-cpu"></i>
                <span class="node-title" data-node-id="${nodeId}">节点 ${nodeId}</span>
            </h6>
            <div>
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleNodeConfig(this)" data-bs-toggle="tooltip" title="展开/折叠">
                    <i class="bi bi-chevron-down"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeNodeConfig(this)">
                    <i class="bi bi-trash"></i>
                    删除节点配置
                </button>
            </div>
        </div>
        
        <div class="param-content" style="display: none;">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="param-params-container">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addParamConfig(this)">
                            <i class="bi bi-plus"></i>
                            添加参数
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    container.appendChild(div);
    
    // 更新新节点的标题
    updateNodeTitles();
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('nodeSelectModal'));
    modal.hide();
}

function removeNodeConfig(button) {
    button.closest('.param-item').remove();
}

// 添加参数配置
function addParamConfig(button) {
    // 获取当前节点ID
    const nodeItem = button.closest('.param-item');
    const nodeId = nodeItem.getAttribute('data-node-id');
    
    if (!nodeId) {
        alert('无法获取节点ID');
        return;
    }
    
    // 解析工作流JSON获取该节点的inputs
    const workflowJsonElement = document.getElementById('workflowJson');
    if (!workflowJsonElement || !workflowJsonElement.value.trim()) {
        alert('请先解析工作流JSON');
        return;
    }
    const workflowJson = workflowJsonElement.value;
    
    try {
        const workflow = JSON.parse(workflowJson);
        const nodeData = workflow[nodeId];
        
        if (!nodeData || !nodeData.inputs) {
            alert(`节点 ${nodeId} 没有找到 inputs 数据`);
            return;
        }
        
        // 获取已配置的参数名
        const container = button.parentElement;
        const existingParams = Array.from(container.querySelectorAll('.param-config-item'))
            .map(item => item.getAttribute('data-param-name'));
        
        // 获取可配置的参数（排除已配置的）
        const availableInputs = Object.keys(nodeData.inputs).filter(paramName => 
            !existingParams.includes(paramName)
        );
        
        if (availableInputs.length === 0) {
            alert('该节点的所有参数都已配置');
            return;
        }
        
        // 创建选择对话框
        let inputOptions = availableInputs.map(paramName => {
            const inputValue = nodeData.inputs[paramName];
            let valueDisplay = '';
            
            // 处理不同类型的输入值显示
            if (Array.isArray(inputValue)) {
                valueDisplay = ` [连接: ${inputValue[0]}]`;
            } else if (typeof inputValue === 'string') {
                valueDisplay = ` = "${inputValue}"`;
            } else if (typeof inputValue === 'number') {
                valueDisplay = ` = ${inputValue}`;
            } else {
                valueDisplay = ` = ${JSON.stringify(inputValue)}`;
            }
            
            return `<option value="${paramName}">${paramName}${valueDisplay}</option>`;
        }).join('');
        
        // 创建模态框选择参数
        const modalHtml = `
            <div class="modal fade" id="paramSelectModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">选择要配置的参数 - 节点 ${nodeId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label">可配置的参数：</label>
                            <select class="form-select" id="paramSelect">
                                ${inputOptions}
                            </select>
                            <div class="mt-3">
                                <small class="text-muted">
                                    参数值类型：字符串显示引号，数字直接显示，数组表示连接到其他节点
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" onclick="confirmAddParamConfig('${nodeId}')">确定</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除已存在的模态框
        const existingModal = document.getElementById('paramSelectModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // 添加新模态框
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('paramSelectModal'));
        modal.show();
        
    } catch (error) {
        console.error('解析工作流JSON时出错:', error);
        alert('解析工作流JSON时出错，请检查JSON格式');
    }
}

// 确认添加参数配置
function confirmAddParamConfig(nodeId) {
    const select = document.getElementById('paramSelect');
    if (!select || !select.value) {
        alert('请选择一个参数');
        return;
    }
    const paramName = select.value;
    
    // 获取工作流数据以获取参数的默认值
    const workflowJsonElement = document.getElementById('workflowJson');
    if (!workflowJsonElement) {
        alert('无法找到工作流JSON元素');
        return;
    }
    const workflowJson = workflowJsonElement.value;
    let defaultValue = '';
    let paramType = 'text';
    
    try {
        const workflow = JSON.parse(workflowJson);
        const nodeData = workflow[nodeId];
        const inputValue = nodeData.inputs[paramName];
        
        // 根据输入值类型设置默认值和参数类型
        if (Array.isArray(inputValue)) {
            // 数组类型表示连接到其他节点，这种情况下可能需要特殊处理
            defaultValue = '';
            paramType = 'text';
        } else if (typeof inputValue === 'string') {
            defaultValue = inputValue;
            paramType = 'text';
        } else if (typeof inputValue === 'number') {
            defaultValue = inputValue.toString();
            paramType = 'number';
        } else if (typeof inputValue === 'boolean') {
            defaultValue = inputValue.toString();
            paramType = 'boolean';
        } else {
            defaultValue = JSON.stringify(inputValue);
            paramType = 'text';
        }
    } catch (error) {
        console.error('获取参数默认值时出错:', error);
    }
    
    const container = document.querySelector(`.param-item[data-node-id="${nodeId}"] .param-params-container`);
    const addButton = container.querySelector('button[onclick="addParamConfig(this)"]');
    
    const div = document.createElement('div');
    div.className = 'param-config-item mb-3 p-3 border rounded';
    div.setAttribute('data-param-name', paramName);
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>${paramName}</strong>
            <div>
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleParamConfig(this)" data-bs-toggle="tooltip" title="展开/折叠">
                    <i class="bi bi-chevron-down"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeParamConfig(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="param-config-content" style="display: none;">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">参数名</label>
                    <input type="text" class="form-control" name="param_name" value="${paramName}" readonly>
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">类型</label>
                    <select class="form-select" name="param_type">
                        <option value="text" ${paramType === 'text' ? 'selected' : ''}>文本</option>
                        <option value="number" ${paramType === 'number' ? 'selected' : ''}>数字</option>
                        <option value="select">选择</option>
                        <option value="boolean" ${paramType === 'boolean' ? 'selected' : ''}>布尔值</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">默认值</label>
                    <!-- 默认值输入框，会根据类型动态变化 -->
                    <div class="param-default-container">
                        <input type="text" class="form-control param-default-text" name="param_default" value="${defaultValue}">
                        <input type="number" class="form-control param-default-number" name="param_default" value="${defaultValue}" style="display:none;" step="any">
                        <div class="form-check form-switch param-default-boolean" style="display:none;">
                            <input class="form-check-input" type="checkbox" name="param_default" ${defaultValue === 'true' ? 'checked' : ''} onchange="updateBooleanLabel(this)">
                            <label class="form-check-label boolean-label">${defaultValue === 'true' ? 'True' : 'False'}</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-2">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" name="param_required">
                        <label class="form-check-label">必需参数</label>
                    </div>
                </div>
            </div>
            
            <div class="mb-2">
                <label class="form-label">描述</label>
                <textarea class="form-control" name="param_description" rows="2"></textarea>
            </div>
            
            <!-- 数字类型的范围设置 -->
            <div class="param-number-options" style="display:none;">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">最小值</label>
                        <input type="number" class="form-control" name="param_min" step="any">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">最大值</label>
                        <input type="number" class="form-control" name="param_max" step="any">
                    </div>
                </div>
            </div>
            
            <!-- 选择类型的选项设置 -->
            <div class="param-select-options" style="display:none;">
                <div class="mb-2">
                    <label class="form-label">选项 (用逗号分隔)</label>
                    <input type="text" class="form-control" name="param_options" placeholder="选项1,选项2,选项3">
                </div>
            </div>
            
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">特殊功能</label>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleSpecialFeatures(this)" data-bs-toggle="tooltip" title="展开/折叠">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div class="special-features-content" style="display: none;">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="param_inject_models">
                        <label class="form-check-label">注入可用模型列表</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="param_inject_loras">
                        <label class="form-check-label">注入可用LoRA列表</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="param_inject_samplers">
                        <label class="form-check-label">注入可用采样器列表</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="param_inject_schedulers">
                        <label class="form-check-label">注入可用调度器列表</label>
                    </div>
                </div>
            </div>
            
            <div class="mb-2">
                <label class="form-label">别名 (用逗号分隔)</label>
                <input type="text" class="form-control" name="param_aliases">
            </div>
        </div>
    `;
    container.insertBefore(div, addButton);
    
    // 初始化参数类型的动态显示
    initParamTypeControls(div);
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('paramSelectModal'));
    modal.hide();
}

// 初始化参数类型的动态显示控制
function initParamTypeControls(paramItem) {
    const typeSelect = paramItem.querySelector('select[name="param_type"]');
    
    if (!typeSelect) {
        console.warn('param_type select not found in paramItem:', paramItem);
        return;
    }
    
    // 监听类型变化
    typeSelect.addEventListener('change', function() {
        updateParamTypeDisplay(paramItem, this.value);
        updateConfigPreview(); // 更新配置预览
    });
    
    // 为所有参数配置字段添加变化监听器
    const paramFields = [
        'textarea[name="param_description"]',
        'input[name="param_required"]',
        'input[name="param_min"]',
        'input[name="param_max"]',
        'input[name="param_options"]',
        'input[name="param_aliases"]',
        'input[name="param_inject_models"]',
        'input[name="param_inject_loras"]',
        'input[name="param_inject_samplers"]',
        'input[name="param_inject_schedulers"]',
        '.param-default-text',
        '.param-default-number',
        '.param-default-boolean input[name="param_default"]'
    ];
    
    paramFields.forEach(selector => {
        const elements = paramItem.querySelectorAll(selector);
        elements.forEach(element => {
            element.addEventListener('input', updateConfigPreview);
            element.addEventListener('change', updateConfigPreview);
        });
    });
    
    // 初始化显示状态
    updateParamTypeDisplay(paramItem, typeSelect.value);
}

// 根据参数类型更新显示状态
function updateParamTypeDisplay(paramItem, paramType) {
    // 获取各个控制元素
    const defaultText = paramItem.querySelector('.param-default-text');
    const defaultNumber = paramItem.querySelector('.param-default-number');
    const defaultBoolean = paramItem.querySelector('.param-default-boolean');
    const numberOptions = paramItem.querySelector('.param-number-options');
    const selectOptions = paramItem.querySelector('.param-select-options');
    
    // 隐藏所有选项（检查元素是否存在）
    if (defaultText) defaultText.style.display = 'none';
    if (defaultNumber) defaultNumber.style.display = 'none';
    if (defaultBoolean) defaultBoolean.style.display = 'none';
    if (numberOptions) numberOptions.style.display = 'none';
    if (selectOptions) selectOptions.style.display = 'none';
    
    // 根据类型显示相应选项
    switch(paramType) {
        case 'text':
            if (defaultText) defaultText.style.display = 'block';
            break;
            
        case 'number':
            if (defaultNumber) defaultNumber.style.display = 'block';
            if (numberOptions) numberOptions.style.display = 'block';
            break;
            
        case 'select':
            if (defaultText) defaultText.style.display = 'block';
            if (selectOptions) selectOptions.style.display = 'block';
            break;
            
        case 'boolean':
            if (defaultBoolean) {
                defaultBoolean.style.display = 'block';
                // 初始化布尔值标签显示
                const checkbox = defaultBoolean.querySelector('input[type="checkbox"]');
                if (checkbox) updateBooleanLabel(checkbox);
            }
            break;
    }
}

// 更新布尔值开关的显示文字
function updateBooleanLabel(checkbox) {
    if (!checkbox) return;
    const label = checkbox.nextElementSibling;
    if (label && label.classList.contains('boolean-label')) {
        label.textContent = checkbox.checked ? 'True' : 'False';
    }
    // 更新配置预览
    updateConfigPreview();
}

function removeParamConfig(button) {
    button.closest('.param-config-item').remove();
}

// 添加输入映射
function addInputMapping() {
    const container = document.getElementById('inputMappingsContainer');
    const nodeId = prompt('请输入节点ID:');
    if (!nodeId) return;
    
    const div = document.createElement('div');
    div.className = 'mapping-item mb-3 p-3 border rounded';
    div.setAttribute('data-node-id', nodeId);
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>节点 ${nodeId}</strong>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeInputMapping(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label">参数名</label>
                <input type="text" class="form-control" name="input_mapping_param_name" placeholder="如: image">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">类型</label>
                <select class="form-select" name="input_mapping_type">
                    <option value="image">图像</option>
                    <option value="text">文本</option>
                    <option value="number">数字</option>
                    <option value="boolean">布尔值</option>
                </select>
            </div>
        </div>
        <div class="mb-2">
            <label class="form-label">描述</label>
            <textarea class="form-control" name="input_mapping_description" rows="2"></textarea>
        </div>
    `;
    container.appendChild(div);
    
    // 更新新节点的标题
    updateNodeTitles();
}

function removeInputMapping(button) {
    button.closest('.mapping-item').remove();
}

// 添加输出映射
function addOutputMapping() {
    const container = document.getElementById('outputMappingsContainer');
    const nodeId = prompt('请输入节点ID:');
    if (!nodeId) return;
    
    const div = document.createElement('div');
    div.className = 'mapping-item mb-3 p-3 border rounded';
    div.setAttribute('data-node-id', nodeId);
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>节点 ${nodeId}</strong>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOutputMapping(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label">参数名</label>
                <input type="text" class="form-control" name="output_mapping_param_name" placeholder="如: images">
            </div>
            <div class="col-md-6 mb-2">
                <label class="form-label">类型</label>
                <select class="form-select" name="output_mapping_type">
                    <option value="image">图像</option>
                    <option value="text">文本</option>
                    <option value="number">数字</option>
                    <option value="boolean">布尔值</option>
                </select>
            </div>
        </div>
        <div class="mb-2">
            <label class="form-label">描述</label>
            <textarea class="form-control" name="output_mapping_description" rows="2"></textarea>
        </div>
    `;
    container.appendChild(div);
    
    // 更新新节点的标题
    updateNodeTitles();
}

function removeOutputMapping(button) {
    button.closest('.mapping-item').remove();
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    updateMappingPreview();
    
    // 初始化Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // 初始化已存在的参数配置的动态显示
    document.querySelectorAll('.param-config-item').forEach(paramItem => {
        initParamTypeControls(paramItem);
    });
    
    // 为基本表单字段添加变化监听器，以便实时更新配置预览
    const basicFields = ['input[name="name"]', 'input[name="prefix"]', 'textarea[name="description"]', 
                         'input[name="version"]', 'input[name="author"]'];
    basicFields.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.addEventListener('input', updateConfigPreview);
            element.addEventListener('change', updateConfigPreview);
        }
    });
    
    // 等待一小段时间确保所有DOM元素都完全加载
    setTimeout(() => {
        // 自动解析 Workflow JSON 中的节点
        const workflowJsonElement = document.getElementById('workflowJson');
        if (workflowJsonElement && workflowJsonElement.value.trim()) {
            parseWorkflowNodes();
            
            // 在节点解析完成后立即恢复已保存的值
            setTimeout(() => {
                restoreSavedNodeValues();
                updateNodeTitles(); // 更新节点标题
                updateConfigPreview(); // 更新配置预览
            }, 200); // 确保所有选择框都已填充选项
        }
    }, 100); // 确保模板渲染的选择框已完全创建
});

// 表单提交时构建配置对象
document.getElementById('workflowForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const nameInput = document.querySelector('input[name="name"]');
    const prefixInput = document.querySelector('input[name="prefix"]');
    const descriptionInput = document.querySelector('textarea[name="description"]');
    const versionInput = document.querySelector('input[name="version"]');
    const authorInput = document.querySelector('input[name="author"]');
    
    const config = {
        name: nameInput ? nameInput.value : '',
        prefix: prefixInput ? prefixInput.value : '',
        description: descriptionInput ? descriptionInput.value : '',
        version: versionInput ? versionInput.value : '',
        author: authorInput ? authorInput.value : '',
        input_nodes: Array.from(document.querySelectorAll('select[name="input_nodes"]')).map(select => select.value).filter(v => v),
        output_nodes: Array.from(document.querySelectorAll('select[name="output_nodes"]')).map(select => select.value).filter(v => v),
        configurable_nodes: Array.from(document.querySelectorAll('select[name="configurable_nodes"]')).map(select => select.value).filter(v => v),
        input_mappings: {},
        output_mappings: {},
        node_configs: {}
    };
    
    // 自动生成输入输出映射
    const inputNodes = Array.from(document.querySelectorAll('select[name="input_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    const outputNodes = Array.from(document.querySelectorAll('select[name="output_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    inputNodes.forEach(nodeId => {
        config.input_mappings[nodeId] = {
            parameter_name: "image",
            type: "image",
            description: "输入的原始图像"
        };
    });
    
    outputNodes.forEach(nodeId => {
        config.output_mappings[nodeId] = {
            parameter_name: "images",
            type: "image",
            description: "处理后的图像"
        };
    });
    
    // 构建节点配置
    document.querySelectorAll('.param-item[data-node-id]').forEach(nodeItem => {
        const nodeId = nodeItem.getAttribute('data-node-id');
        config.node_configs[nodeId] = {};
        
        nodeItem.querySelectorAll('.param-config-item').forEach(paramItem => {
            const paramName = paramItem.getAttribute('data-param-name');
            const paramTypeSelect = paramItem.querySelector('select[name="param_type"]');
            const paramType = paramTypeSelect ? paramTypeSelect.value : 'text';
            
            // 根据类型获取默认值
            let defaultValue = null;
            switch(paramType) {
                case 'boolean':
                    const checkbox = paramItem.querySelector('.param-default-boolean input[name="param_default"]');
                    defaultValue = checkbox ? checkbox.checked : false;
                    break;
                case 'number':
                    const numberInput = paramItem.querySelector('.param-default-number');
                    defaultValue = numberInput && numberInput.value ? parseFloat(numberInput.value) : null;
                    break;
                default:
                    const textInput = paramItem.querySelector('.param-default-text');
                    defaultValue = textInput ? textInput.value || null : null;
            }
            
            const descriptionTextarea = paramItem.querySelector('textarea[name="param_description"]');
            const requiredCheckbox = paramItem.querySelector('input[name="param_required"]');
            const minInput = paramItem.querySelector('input[name="param_min"]');
            const maxInput = paramItem.querySelector('input[name="param_max"]');
            
            const paramConfig = {
                type: paramType,
                default: defaultValue,
                description: descriptionTextarea ? descriptionTextarea.value || '' : '',
                required: requiredCheckbox ? requiredCheckbox.checked : false
            };
            
            const minVal = minInput ? minInput.value : '';
            const maxVal = maxInput ? maxInput.value : '';
            if (minVal) paramConfig.min = parseFloat(minVal);
            if (maxVal) paramConfig.max = parseFloat(maxVal);
            
            const optionsInput = paramItem.querySelector('input[name="param_options"]');
            const options = optionsInput ? optionsInput.value : '';
            if (options) paramConfig.options = options.split(',').map(o => o.trim());
            
            const aliasesInput = paramItem.querySelector('input[name="param_aliases"]');
            const aliases = aliasesInput ? aliasesInput.value : '';
            if (aliases) paramConfig.aliases = aliases.split(',').map(a => a.trim());
            
            // 处理特殊功能
            if (paramItem.querySelector('input[name="param_inject_models"]')?.checked) {
                paramConfig.inject_models = true;
            }
            if (paramItem.querySelector('input[name="param_inject_loras"]')?.checked) {
                paramConfig.inject_loras = true;
            }
            if (paramItem.querySelector('input[name="param_inject_samplers"]')?.checked) {
                paramConfig.inject_samplers = true;
            }
            if (paramItem.querySelector('input[name="param_inject_schedulers"]')?.checked) {
                paramConfig.inject_schedulers = true;
            }
            
            config.node_configs[nodeId][paramName] = paramConfig;
        });
    });
    
    const configInput = document.getElementById('configInput');
    if (configInput) {
        configInput.value = JSON.stringify(config, null, 2);
    }
    
    // 提交表单
    this.submit();
});
</script>
{% endblock %}
