{% extends "base.html" %}

{% block title %}新建工作流 - 工作流配置{% endblock %}

{% block page_title %}新建工作流{% endblock %}

{% block page_actions %}
    <div class="btn-group" role="group">
        <button type="submit" form="workflowForm" class="btn btn-success">
            <i class="bi bi-check-circle"></i>
            创建
        </button>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i>
            取消
        </a>
    </div>
{% endblock %}

{% block content %}
<form id="workflowForm" method="post" action="{{ url_for('workflow_create') }}">
    <!-- 基本信息 -->
    <div class="config-section p-4 mb-4">
        <h5 class="mb-4">
            <i class="bi bi-info-circle text-primary"></i>
            基本信息
        </h5>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">工作流名称</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="workflow_name" 
                       placeholder="输入工作流名称（用于存储）" required>
                <div class="form-text">工作流的唯一标识符，用于文件存储和URL路径</div>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">显示名称</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="name" 
                       placeholder="输入显示名称" required>
                <div class="form-text">工作流的显示名称，可以包含中文和特殊字符</div>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">前缀</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="prefix" 
                       placeholder="输入调用前缀" required>
                <div class="form-text">用于调用此工作流的前缀，如: encrypt</div>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">描述</label>
            <div class="col-sm-10">
                <textarea class="form-control" name="description" rows="3" 
                          placeholder="输入工作流描述"></textarea>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">版本</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="version" 
                       value="1.0.0">
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">作者</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="author" 
                       value="ComfyUI Plugin">
            </div>
        </div>
    </div>

    <!-- Workflow JSON -->
    <div class="config-section p-4 mb-4">
        <h5 class="mb-4">
            <i class="bi bi-code-slash text-info"></i>
            Workflow JSON
        </h5>
        
        <div class="mb-3">
            <label class="form-label">ComfyUI Workflow JSON</label>
            <textarea class="form-control json-editor" name="workflow" rows="15" id="workflowJson"
                      placeholder="粘贴 ComfyUI 的 workflow JSON 配置...">{}</textarea>
            <div class="form-text">
                这是 ComfyUI 的 workflow JSON 配置，可以从 ComfyUI 界面导出。
            </div>
        </div>
        
        <div class="mt-3">
            <button type="button" class="btn btn-outline-primary" onclick="parseWorkflowNodes()">
                <i class="bi bi-arrow-repeat"></i>
                解析节点
            </button>
            <div class="form-text">点击此按钮解析 JSON 中的所有节点，然后可以在下方选择节点</div>
        </div>
    </div>

    <!-- 节点配置 -->
    <div class="config-section p-4 mb-4">
        <h5 class="mb-4">
            <i class="bi bi-diagram-2 text-success"></i>
            节点配置
        </h5>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">输入节点</label>
            <div class="col-sm-10">
                <div id="inputNodesList">
                    <div class="input-group mb-2">
                        <select class="form-select node-selector" name="input_nodes" onchange="updateMappingPreview()">
                            <option value="">-- 选择节点 --</option>
                        </select>
                        <button type="button" class="btn btn-outline-danger" onclick="removeInputNode(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addInputNode()">
                    <i class="bi bi-plus"></i>
                    添加输入节点
                </button>
                <div class="form-text">输入节点是接收外部数据的节点，如图片输入节点</div>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">输出节点</label>
            <div class="col-sm-10">
                <div id="outputNodesList">
                    <div class="input-group mb-2">
                        <select class="form-select node-selector" name="output_nodes" onchange="updateMappingPreview()">
                            <option value="">-- 选择节点 --</option>
                        </select>
                        <button type="button" class="btn btn-outline-danger" onclick="removeOutputNode(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOutputNode()">
                    <i class="bi bi-plus"></i>
                    添加输出节点
                </button>
                <div class="form-text">输出节点是最终输出结果的节点，如保存图片节点</div>
            </div>
        </div>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">可配置节点</label>
            <div class="col-sm-10">
                <div id="configurableNodesList">
                    <div class="input-group mb-2">
                        <select class="form-select node-selector" name="configurable_nodes">
                            <option value="">-- 选择节点 --</option>
                        </select>
                        <button type="button" class="btn btn-outline-danger" onclick="removeConfigurableNode(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addConfigurableNode()">
                    <i class="bi bi-plus"></i>
                    添加可配置节点
                </button>
                <div class="form-text">可配置节点是用户可以在运行时修改参数的节点</div>
            </div>
        </div>
    </div>

    <!-- 自动映射预览 -->
    <div class="config-section p-4 mb-4">
        <h5 class="mb-4">
            <i class="bi bi-arrow-left-right text-warning"></i>
            自动映射预览
        </h5>
        
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>自动映射规则：</strong>输入节点将自动映射为输入参数，输出节点将自动映射为输出参数。无需手动配置。
        </div>
        
        <!-- 输入映射预览 -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="mb-3">
                    <i class="bi bi-box-arrow-in-right"></i>
                    输入映射预览
                </h6>
                <div id="inputMappingsPreview" class="border rounded p-3 bg-light">
                    <p class="text-muted">暂无输入节点</p>
                </div>
            </div>
        </div>
        
        <!-- 输出映射预览 -->
        <div class="row">
            <div class="col-12">
                <h6 class="mb-3">
                    <i class="bi bi-box-arrow-right"></i>
                    输出映射预览
                </h6>
                <div id="outputMappingsPreview" class="border rounded p-3 bg-light">
                    <p class="text-muted">暂无输出节点</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 模板选择 -->
    <div class="config-section p-4 mb-4">
        <h5 class="mb-4">
            <i class="bi bi-file-earmark-template text-info"></i>
            使用模板
        </h5>
        
        <div class="row mb-3">
            <label class="col-sm-2 col-form-label">选择模板</label>
            <div class="col-sm-10">
                <select class="form-select" id="templateSelect" onchange="loadTemplate()">
                    <option value="">-- 选择模板 --</option>
                </select>
                <div class="form-text">选择预设模板可以快速创建工作流配置</div>
            </div>
        </div>
    </div>



    <!-- 隐藏字段 -->
    <input type="hidden" name="input_mappings" id="inputMappingsInput">
    <input type="hidden" name="output_mappings" id="outputMappingsInput">
    <input type="hidden" name="node_configs" id="nodeConfigsInput">
</form>
{% endblock %}

{% block scripts %}
<script>
// 解析 Workflow JSON 中的节点
function parseWorkflowNodes() {
    const workflowJson = document.getElementById('workflowJson').value;
    if (!workflowJson.trim()) {
        alert('请先输入 Workflow JSON');
        return;
    }
    
    try {
        const workflow = JSON.parse(workflowJson);
        const nodes = [];
        
        // 提取所有节点信息
        for (const [nodeId, nodeData] of Object.entries(workflow)) {
            const title = nodeData._meta?.title || nodeData.class_type || `节点 ${nodeId}`;
            nodes.push({
                id: nodeId,
                title: title,
                class_type: nodeData.class_type
            });
        }
        
        // 按节点ID排序
        nodes.sort((a, b) => parseInt(a.id) - parseInt(b.id));
        
        // 更新所有下拉选择框
        updateAllNodeSelectors(nodes);
        
    } catch (error) {
        console.error('JSON 格式错误：', error.message);
    }
}

// 更新所有节点选择器
function updateAllNodeSelectors(nodes) {
    const selectors = document.querySelectorAll('.node-selector');
    selectors.forEach(selector => {
        // 保存当前选中的值
        const currentValue = selector.value;
        
        // 清空并重新填充选项
        selector.innerHTML = '<option value="">-- 选择节点 --</option>';
        
        nodes.forEach(node => {
            const option = document.createElement('option');
            option.value = node.id;
            option.textContent = `${node.id} - ${node.title}`;
            if (node.class_type) {
                option.textContent += ` (${node.class_type})`;
            }
            selector.appendChild(option);
        });
        
        // 恢复之前选中的值
        if (currentValue) {
            selector.value = currentValue;
        }
    });
}

// 加载模板列表
document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    updateMappingPreview();
});

async function loadTemplates() {
    try {
        const response = await fetch('/api/workflow_templates');
        const templates = await response.json();
        const select = document.getElementById('templateSelect');
        
        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.name;
            option.textContent = `${template.name} - ${template.description}`;
            option.dataset.template = JSON.stringify(template);
            select.appendChild(option);
        });
    } catch (error) {
        console.error('加载模板失败:', error);
    }
}

function loadTemplate() {
    const select = document.getElementById('templateSelect');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption.value) return;
    
    try {
        const template = JSON.parse(selectedOption.dataset.template);
        
        // 填充基本信息
        document.querySelector('input[name="name"]').value = template.name || '';
        document.querySelector('input[name="prefix"]').value = template.prefix || '';
        document.querySelector('textarea[name="description"]').value = template.description || '';
        document.querySelector('input[name="version"]').value = template.version || '1.0.0';
        document.querySelector('input[name="author"]').value = template.author || 'ComfyUI Plugin';
        
        // 清空现有节点列表
        document.getElementById('inputNodesList').innerHTML = '';
        document.getElementById('outputNodesList').innerHTML = '';
        document.getElementById('configurableNodesList').innerHTML = '';
        
        // 添加输入节点
        if (template.input_nodes && template.input_nodes.length > 0) {
            template.input_nodes.forEach(nodeId => {
                addInputNode(nodeId);
            });
        } else {
            addInputNode();
        }
        
        // 添加输出节点
        if (template.output_nodes && template.output_nodes.length > 0) {
            template.output_nodes.forEach(nodeId => {
                addOutputNode(nodeId);
            });
        } else {
            addOutputNode();
        }
        
        // 添加可配置节点
        if (template.configurable_nodes && template.configurable_nodes.length > 0) {
            template.configurable_nodes.forEach(nodeId => {
                addConfigurableNode(nodeId);
            });
        } else {
            addConfigurableNode();
        }
        
        // 更新映射预览
        setTimeout(updateMappingPreview, 100);
        
        document.getElementById('nodeConfigsInput').value = JSON.stringify(template.node_configs || {});
        
    } catch (error) {
        console.error('加载模板失败:', error);
        alert('加载模板失败: ' + error.message);
    }
}

// 添加输入节点
function addInputNode(value = '') {
    const list = document.getElementById('inputNodesList');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <select class="form-select node-selector" name="input_nodes" onchange="updateMappingPreview()">
            <option value="">-- 选择节点 --</option>
        </select>
        <button type="button" class="btn btn-outline-danger" onclick="removeInputNode(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    list.appendChild(div);
    
    // 如果已经解析过节点，更新选择器
    const workflowJson = document.getElementById('workflowJson').value;
    if (workflowJson.trim()) {
        parseWorkflowNodes();
    }
    
    // 如果有预设值，设置它
    if (value) {
        setTimeout(() => {
            const selectors = list.querySelectorAll('.node-selector');
            const lastSelector = selectors[selectors.length - 1];
            if (lastSelector) {
                lastSelector.value = value;
            }
        }, 100);
    }
    
    // 更新映射预览
    updateMappingPreview();
}

function removeInputNode(button) {
    button.parentElement.remove();
    updateMappingPreview();
}

// 添加输出节点
function addOutputNode(value = '') {
    const list = document.getElementById('outputNodesList');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <select class="form-select node-selector" name="output_nodes" onchange="updateMappingPreview()">
            <option value="">-- 选择节点 --</option>
        </select>
        <button type="button" class="btn btn-outline-danger" onclick="removeOutputNode(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    list.appendChild(div);
    
    // 如果已经解析过节点，更新选择器
    const workflowJson = document.getElementById('workflowJson').value;
    if (workflowJson.trim()) {
        parseWorkflowNodes();
    }
    
    // 如果有预设值，设置它
    if (value) {
        setTimeout(() => {
            const selectors = list.querySelectorAll('.node-selector');
            const lastSelector = selectors[selectors.length - 1];
            if (lastSelector) {
                lastSelector.value = value;
            }
        }, 100);
    }
    
    // 更新映射预览
    updateMappingPreview();
}

function removeOutputNode(button) {
    button.parentElement.remove();
    updateMappingPreview();
}

// 添加可配置节点
function addConfigurableNode(value = '') {
    const list = document.getElementById('configurableNodesList');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <select class="form-select node-selector" name="configurable_nodes">
            <option value="">-- 选择节点 --</option>
        </select>
        <button type="button" class="btn btn-outline-danger" onclick="removeConfigurableNode(this)">
            <i class="bi bi-trash"></i>
        </button>
    `;
    list.appendChild(div);
    
    // 如果已经解析过节点，更新选择器
    const workflowJson = document.getElementById('workflowJson').value;
    if (workflowJson.trim()) {
        parseWorkflowNodes();
    }
    
    // 如果有预设值，设置它
    if (value) {
        setTimeout(() => {
            const selectors = list.querySelectorAll('.node-selector');
            const lastSelector = selectors[selectors.length - 1];
            if (lastSelector) {
                lastSelector.value = value;
            }
        }, 100);
    }
}

function removeConfigurableNode(button) {
    button.parentElement.remove();
}

// 更新映射预览
function updateMappingPreview() {
    // 更新输入映射预览
    const inputNodes = Array.from(document.querySelectorAll('select[name="input_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    const inputPreview = document.getElementById('inputMappingsPreview');
    if (inputNodes.length > 0) {
        const inputMappings = {};
        inputNodes.forEach(nodeId => {
            inputMappings[nodeId] = {
                parameter_name: "image",
                type: "image",
                description: "输入的原始图像"
            };
        });
        inputPreview.innerHTML = `<pre><code>${JSON.stringify(inputMappings, null, 2)}</code></pre>`;
    } else {
        inputPreview.innerHTML = '<p class="text-muted">暂无输入节点</p>';
    }
    
    // 更新输出映射预览
    const outputNodes = Array.from(document.querySelectorAll('select[name="output_nodes"]'))
        .map(select => select.value.trim())
        .filter(v => v);
    
    const outputPreview = document.getElementById('outputMappingsPreview');
    if (outputNodes.length > 0) {
        const outputMappings = {};
        outputNodes.forEach(nodeId => {
            outputMappings[nodeId] = {
                parameter_name: "images",
                type: "image",
                description: "处理后的图像"
            };
        });
        outputPreview.innerHTML = `<pre><code>${JSON.stringify(outputMappings, null, 2)}</code></pre>`;
    } else {
        outputPreview.innerHTML = '<p class="text-muted">暂无输出节点</p>';
    }
}

// 表单提交时的处理
document.getElementById('workflowForm').addEventListener('submit', function(e) {
    // 基本验证
    const workflowName = document.querySelector('input[name="workflow_name"]').value.trim();
    const displayName = document.querySelector('input[name="name"]').value.trim();
    const prefix = document.querySelector('input[name="prefix"]').value.trim();
    
    if (!workflowName) {
        e.preventDefault();
        alert('请输入工作流名称！');
        return;
    }
    
    if (!displayName) {
        e.preventDefault();
        alert('请输入显示名称！');
        return;
    }
    
    if (!prefix) {
        e.preventDefault();
        alert('请输入前缀！');
        return;
    }
    
    // 验证工作流名称只包含字母、数字、下划线和连字符
    if (!/^[a-zA-Z0-9_-]+$/.test(workflowName)) {
        e.preventDefault();
        alert('工作流名称只能包含字母、数字、下划线和连字符！');
        return;
    }
    
    // 自动生成输入输出映射
    const inputNodes = Array.from(document.querySelectorAll('input[name="input_nodes"]'))
        .map(input => input.value.trim())
        .filter(v => v);
    
    const outputNodes = Array.from(document.querySelectorAll('input[name="output_nodes"]'))
        .map(input => input.value.trim())
        .filter(v => v);
    
    const inputMappings = {};
    inputNodes.forEach(nodeId => {
        inputMappings[nodeId] = {
            parameter_name: "image",
            type: "image",
            description: "输入的原始图像"
        };
    });
    
    const outputMappings = {};
    outputNodes.forEach(nodeId => {
        outputMappings[nodeId] = {
            parameter_name: "images",
            type: "image",
            description: "处理后的图像"
        };
    });
    
    document.getElementById('inputMappingsInput').value = JSON.stringify(inputMappings);
    document.getElementById('outputMappingsInput').value = JSON.stringify(outputMappings);
});
</script>
{% endblock %}