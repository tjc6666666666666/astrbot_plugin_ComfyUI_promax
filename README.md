# Astrbot ComfyUI 插件使用文档

## 📖 插件简介

这是一个功能强大的Astrbot插件，集成了ComfyUI AI绘画功能，支持文生图、图生图、多服务器轮询、模型选择、LoRA支持等高级功能。

## 🚀 主要功能

### 🎨 AI绘画功能
- **文生图**：通过文字描述生成图片
- **图生图**：基于现有图片进行二次创作
- **批量生成**：支持一次生成多张图片
- **多服务器支持**：自动轮询多个ComfyUI服务器

### 🛠️ 高级特性
- **模型选择**：支持切换不同的AI模型
- **LoRA支持**：可使用多个LoRA模型增强效果
- **图片加密**：希尔伯特曲线图像加密保护
- **自动保存**：生成的图片自动保存到本地
- **压缩包下载**：支持打包下载当日生成的图片
- **帮助系统**：支持文本和图片形式的帮助信息

## 📋 安装要求

### Python依赖包
```txt
aiohttp>=3.8.0
Pillow>=9.0.0
aiofiles>=0.8.0
asyncio-throttle>=1.0.0
```

### ComfyUI自定义节点
需要在ComfyUI中安装以下自定义节点：

1. **图像压缩器** (`image_compressor`)
   - 作用：压缩和优化输入图片
   - 安装位置：ComfyUI/custom_nodes/image_compressor

2. **希尔伯特图像加密** (`hilbert_image_encrypt`)
   - 作用：对生成的图片进行加密保护
   - 安装位置：ComfyUI/custom_nodes/hilbert_image_encrypt

> ⚠️ **重要提示**：如果开启了图片解密功能，用户需要自行搜索"小番茄图片混淆"工具进行解密。





## 📝 使用方法

### 文生图指令
```
aimg <提示词> [宽X,高Y] [批量N] [model:描述] [lora:描述[:强度][!CLIP强度]]
```

**示例：**
```
aimg 美少女 宽512,高768 批量2 model:写实风格 lora:儿童:0.8 lora:可爱!1.0
```

### 图生图指令
```
img2img <提示词> [噪声:数值] [批量N] [model:描述] [lora:描述[:强度][!CLIP强度]] + 图片
```

**示例：**
```
img2img 猫咪 噪声:0.7 批量2 model:动漫风格 lora:动物:1.2!0.9
```
（发送时需要附带图片或引用包含图片的消息）

### 压缩包下载指令
```
comfyuioutput
```

### 帮助指令
```
aimg
img2img
```
（单独输入，无参数）

## 🎯 参数详解

### 模型选择
- **格式**：`model:描述`
- **示例**：`model:写实风格`
- **说明**：描述对应配置中的模型描述

### LoRA使用
- **基础格式**：`lora:描述`（使用默认强度1.0/1.0）
- **仅模型强度**：`lora:描述:0.8`（strength_model=0.8）
- **仅CLIP强度**：`lora:描述!1.0`（strength_clip=1.0）
- **双强度**：`lora:描述:0.8!1.3`（model=0.8, clip=1.3）
- **多LoRA**：空格分隔多个lora参数

### 分辨率设置
- **格式**：`宽X,高Y`
- **示例**：`宽512,高768`
- **范围**：64~2000像素

### 批量设置
- **格式**：`批量N`
- **示例**：`批量2`
- **限制**：文生图最大6张，图生图最大6张

### 噪声系数（仅图生图）
- **格式**：`噪声:数值`
- **示例**：`噪声:0.7`
- **范围**：0-1之间

## 📊 功能限制

### 时间限制
- **开放时间**：默认为 7:00-8:00,11:00-14:00,17:00-24:00
- **可配置**：支持自定义时间段和跨零点设置

### 队列限制
- **最大任务队列**：10个
- **每用户最大并发**：3个
- **文生图最大批量**：6张
- **图生图最大批量**：6张

### 下载限制
- **每日下载限制**：1次（可配置）
- **仅限自己图片**：默认开启

## 🔧 高级功能

### 图片加密保护
- 使用希尔伯特曲线算法对生成的图片进行加密
- 防止图片被直接识别和滥用
- 用户需要使用专门的解密工具查看原图

### 自动保存系统
- 按日期自动分类保存：`output/YYYY/MM/DD/`
- 文件名包含时间戳：`YYYYMMDD_HHMMSS_原文件名`
- 支持数据库记录用户生成历史

### 多服务器轮询
- 自动检测服务器健康状态
- 智能负载均衡分配任务
- 故障服务器自动重试机制

### 帮助系统
- **文本帮助**：详细的文字说明和参数列表
- **图片帮助**：精美的图片形式帮助文档
- **实时状态**：显示服务器状态和系统信息

## 🛠️ 故障排除

### 常见问题

1. **服务器连接失败**
   - 检查ComfyUI服务是否启动
   - 确认网络连接正常
   - 验证端口配置正确

2. **模型加载失败**
   - 确认模型文件存在于所有服务器
   - 检查文件名是否匹配配置
   - 验证模型格式兼容性

3. **LoRA使用失败**
   - 确认LoRA文件存在于所有服务器
   - 检查LoRA配置格式正确
   - 验证强度参数在有效范围内

4. **图片保存失败**
   - 检查保存目录权限
   - 确认磁盘空间充足
   - 验证路径配置正确

5. **压缩包下载失败**
   - 确认已开启自动保存功能
   - 检查当日是否有生成图片
   - 验证下载次数未超限

### 日志查看
插件运行日志会输出到Astrbot主日志中，包含：
- 任务执行状态
- 服务器连接情况
- 错误信息和调试信息

## 📈 性能优化

### 服务器配置建议
- 使用SSD存储提高IO性能
- 配置足够的GPU显存
- 确保网络带宽充足

### 参数调优建议
- 根据硬件性能调整批量大小
- 合理设置队列大小避免内存溢出
- 优化采样步数平衡质量和速度

## 🔐 安全说明

### 图片加密
- 生成的图片默认经过希尔伯特曲线加密
- 加密后的图片无法被直接识别
- 用户需要使用专门的解密工具

### 访问控制
- 支持用户级别的下载限制
- 可配置仅允许下载自己生成的图片
- 提供详细的操作日志记录




### 问题反馈
如遇到问题，请提供以下信息：
- Astrbot版本
- ComfyUI版本
- 错误日志
- 配置信息
- 复现步骤

---

